'use strict';var iFrameTemplate='iframe-template',iFrameWidth=410,iFrameHeight=500,load=function(){var addBtn=document.getElementById('add-frame'),framesCount=0;addBtn.addEventListener('click',function(e){e.preventDefault(),document.querySelector('.manual').style.display='none';var iFrame=createIFrame();frameIsSet(iFrame)&&isLoaded(iFrame,function(){setupIFrame(iFrame),window.addEventListener('message',receiveMessage,!1),setJoiningMessage(iFrame)})});var setJoiningMessage=function(iFrame){for(var frames=window.frames,frameName=iFrame.contentWindow.frames.name,i=0;i<frames.length;i++){if(frameName===frames[i].name)return;var frameDoc=frames[i].document,newMessageDiv=frameDoc.createElement('div');newMessageDiv.className='message';var messageSpan=frameDoc.createElement('span');messageSpan.className='system-text';var newMessageText=frameDoc.createTextNode('iframe '+framesCount+' joined to the conversation');messageSpan.appendChild(newMessageText);var hostSpan=frameDoc.createElement('span'),newMessageHost=frameDoc.createTextNode('[system]: ');hostSpan.className='system-host',hostSpan.appendChild(newMessageHost),newMessageDiv.appendChild(hostSpan),newMessageDiv.appendChild(messageSpan);var messageHistoryDiv=frameDoc.getElementById('message-history');messageHistoryDiv.appendChild(newMessageDiv)}},receiveMessage=function(event){var data=event.data,origin=event.origin,source=event.source;origin!==document.location.origin||sendToFrames(source,data.message)},createIFrame=function(){var iFrame=document.createElement('iframe');return iFrame.setAttribute('src',iFrameTemplate+'.html'),iFrame.style.width=iFrameWidth+'px',iFrame.style.height=iFrameHeight+'px',framesCount++,iFrame.setAttribute('name','frame-'+framesCount),iFrame.setAttribute('class','draggable'),document.body.appendChild(iFrame)},isLoaded=function(iFrame,callback){iFrame.onload=function(){callback()}},setupIFrame=function(iFrame){var frameDoc=iFrame.contentDocument,header=frameDoc.querySelector('.header');if(header.innerHTML=header.innerHTML+' '+framesCount,!!localStorage.getItem('chat-history')){var chatHistory=JSON.parse(localStorage.getItem('chat-history'));insertMessageHistory(iFrame,chatHistory)}},insertMessageHistory=function(iFrame,chatHistory){var frameDoc=iFrame.contentDocument;chatHistory.forEach(function(value){insert(frameDoc,value.sender,value.message)})},sendToFrames=function(frameWin,message){for(var frames=window.frames,frameName=frameWin.frames.name,i=0;i<frames.length;i++)insertNewMessage(frames[i],message,frameName);saveHistory(frameName,message)},insertNewMessage=function(frameWin,message,senderName){var frameDoc=frameWin.document;frameWin.frames.name===senderName?insert(frameDoc,senderName,message,!0):insert(frameDoc,senderName,message),frameWin.scrollTo(frameDoc.body.scrollTop,frameDoc.body.scrollHeight)},insert=function(frameDoc,senderName,message){var isSender=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,newMessageDiv=frameDoc.createElement('div'),mesageBlock=frameDoc.createElement('blockquote');mesageBlock.className='sender';var messageSpan=frameDoc.createElement('span');messageSpan.className='sender-text',newMessageDiv.className='message';var newMessageText=frameDoc.createTextNode(message);if(messageSpan.appendChild(newMessageText),isSender)mesageBlock.className+=' sender-right';else{var newMessageHost=frameDoc.createTextNode('['+senderName+']'),hostSpan=frameDoc.createElement('span');hostSpan.className='sender-name',hostSpan.appendChild(newMessageHost),mesageBlock.appendChild(hostSpan)}mesageBlock.appendChild(messageSpan),newMessageDiv.appendChild(mesageBlock);var messageHistoryDiv=frameDoc.getElementById('message-history');messageHistoryDiv.appendChild(newMessageDiv)},saveHistory=function(senderName,message){localStorage.getItem('chat-history')||localStorage.setItem('chat-history',JSON.stringify([]));var chatHistory=JSON.parse(localStorage.getItem('chat-history'));chatHistory.push({sender:senderName,message:message}),localStorage.setItem('chat-history',JSON.stringify(chatHistory))},frameIsSet=function(iFrame){return'undefined'!=typeof iFrame||(console.log('There is no frame found!'),!1)}};window.onload=load;var clearStorage=function(){localStorage.removeItem('chat-history'),localStorage.removeItem('styles')},storeStyles=function(){clearStorage();var loadedStyles=document.styleSheets;localStorage.getItem('styles')||localStorage.setItem('styles',JSON.stringify([]));for(var styles=JSON.parse(localStorage.getItem('styles')),i=0;i<loadedStyles.length;i++)if(loadedStyles[i]){var styleToStore={href:loadedStyles[i].href};styles.push(styleToStore)}localStorage.setItem('styles',JSON.stringify(styles))};storeStyles();