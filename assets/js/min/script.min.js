'use strict';

var iFrameTemplate = 'iframe-template';
var iFrameWidth = 240; //pixels
var iFrameHeight = 240; //pixels

var load = function load() {
  var addBtn = document.getElementById('add-frame');

  var framesCount = 0;
  // add frame on screen
  addBtn.addEventListener('click', function (e) {
    e.preventDefault();
    var iFrame = createIFrame();
    // end if no iframe found
    if (!frameIsSet(iFrame)) return;

    isLoaded(iFrame, function () {
      setupIFrame(iFrame);
      window.addEventListener("message", receiveMessage, false);
    });
  });

  // receive message from the iframe
  var receiveMessage = function receiveMessage(event) {
    var data = event.data,
        origin = event.origin,
        source = event.source;

    if (origin !== document.location.origin) return;
    sendToFrames(source, data.message);
  };

  // init and create frame
  var createIFrame = function createIFrame() {
    var iFrame = document.createElement('iframe');
    iFrame.setAttribute('src', iFrameTemplate + '.html');
    iFrame.style.width = iFrameWidth + 'px';
    iFrame.style.height = iFrameHeight + 'px';
    framesCount++;
    iFrame.setAttribute('name', 'frame-' + framesCount);

    return document.body.appendChild(iFrame);
  };

  // wrapper for loaded iframes
  var isLoaded = function isLoaded(iFrame, callback) {
    iFrame.onload = function () {
      callback();
    };
  };

  // setup iframe
  var setupIFrame = function setupIFrame(iFrame) {
    var frameDoc = iFrame.contentDocument;
    var header = frameDoc.querySelector('h1.header');
    header.innerHTML = header.innerHTML + ' ' + framesCount;
    // set joining message
    var messageHistory = frameDoc.querySelectorAll('.message span');
    var host = messageHistory[0];
    var message = messageHistory[1];
    host.innerHTML = '[system]: ';
    message.innerHTML = 'iframe ' + framesCount + ' joined the conversation';
    // get message history
    if (!localStorage.getItem('chat-history')) return;
    var chatHistory = JSON.parse(localStorage.getItem('chat-history'));
    insertMessageHistory(iFrame, chatHistory);
  };

  // insert message history
  var insertMessageHistory = function insertMessageHistory(iFrame, chatHistory) {
    var frameDoc = iFrame.contentDocument;
    chatHistory.forEach(function (value) {
      insert(frameDoc, value.sender, value.message);
    });
  };

  // sending data to iFrames
  var sendToFrames = function sendToFrames(frameWin, message) {
    var frames = window.frames;
    var frameName = frameWin.frames.name;
    for (var i = 0; i < frames.length; i++) {
      insertNewMessage(frames[i], message, frameName);
    }
    // store message
    saveHistory(frameName, message);
  };

  // arrange inserting new message
  var insertNewMessage = function insertNewMessage(frameWin, message, senderName) {
    var frameDoc = frameWin.document;
    insert(frameDoc, senderName, message);
  };

  // insert message template
  var insert = function insert(frameDoc, senderName, message) {
    var newMessageDiv = frameDoc.createElement('div');
    var hostSpan = frameDoc.createElement('span');
    var messageSpan = frameDoc.createElement('span');
    newMessageDiv.className = 'message';
    var newMessageHost = frameDoc.createTextNode('[' + senderName + ']: ');
    hostSpan.appendChild(newMessageHost);
    newMessageDiv.appendChild(hostSpan);
    var newMessageText = frameDoc.createTextNode(message);
    messageSpan.appendChild(newMessageText);
    newMessageDiv.appendChild(messageSpan);
    var messageHistoryDiv = frameDoc.getElementById('message-history');
    messageHistoryDiv.appendChild(newMessageDiv);
  };

  // store message in localstorage
  var saveHistory = function saveHistory(senderName, message) {
    if (!localStorage.getItem('chat-history')) localStorage.setItem('chat-history', JSON.stringify([]));
    var chatHistory = JSON.parse(localStorage.getItem('chat-history'));
    var messageToStore = {
      'sender': senderName,
      'message': message
    };
    chatHistory.push(messageToStore);
    localStorage.setItem('chat-history', JSON.stringify(chatHistory));
  };

  // check if iframe is set
  var frameIsSet = function frameIsSet(iFrame) {
    if (typeof iFrame === 'undefined') {
      console.log('There is no frame found!');
      return false;
    }
    return true;
  };
};

window.onload = load;

// clear localstorage
var clearStorage = function clearStorage() {
  localStorage.removeItem('chat-history');
};
clearStorage();